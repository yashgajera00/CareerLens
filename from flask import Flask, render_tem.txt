from flask import Flask, render_template, request, session, redirect, url_for, flash
from flask_sqlalchemy import SQLAlchemy
import random
from datetime import datetime

app = Flask(__name__)
app.secret_key = "abc"

# ================= DATABASE CONFIG =================
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://root:@localhost/userdata'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# ================= DATABASE MODELS =================
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100))
    email = db.Column(db.String(120), unique=True, nullable=False)
    userPassword = db.Column(db.String(100), nullable=False)
    bio = db.Column(db.Text, default='')
    skills = db.Column(db.Text, default='')
    interests = db.Column(db.Text, default='')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relationship with assessments
    assessments = db.relationship('Assessment', backref='user', lazy=True)

class Assessment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    assessment_type = db.Column(db.String(50), nullable=False)
    score = db.Column(db.Integer, nullable=False)
    completed_at = db.Column(db.DateTime, default=datetime.utcnow)

class OTP(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(100), nullable=False)
    otp_code = db.Column(db.String(6), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    used = db.Column(db.Boolean, default=False)

class CareerRecommendation(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    career_field = db.Column(db.String(100), nullable=False)
    match_score = db.Column(db.Integer, nullable=False)

class UserCareerField(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    career_field = db.Column(db.String(100), nullable=False)

class Question(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    career_field = db.Column(db.String(100), nullable=False)
    skill = db.Column(db.String(50), nullable=False)
    question_text = db.Column(db.Text, nullable=False)
    option_a = db.Column(db.String(200), nullable=False)
    option_b = db.Column(db.String(200), nullable=False)
    option_c = db.Column(db.String(200), nullable=False)
    option_d = db.Column(db.String(200), nullable=False)
    correct_option = db.Column(db.String(1), nullable=False)  # 'A', 'B', 'C', or 'D'

ALL_CAREERS = ["Software Engineer", "Data Scientist", "AI Engineer", "Cyber Security Expert",
    "Web Developer", "Mobile App Developer", "Cloud Engineer", "DevOps Engineer",
    "Game Developer", "Blockchain Developer",
    "UI/UX Designer", "Graphic Designer", "Product Designer",
    "Project Manager", "Business Analyst", "Product Manager",
    "Digital Marketer", "SEO Specialist", "Content Strategist",
    "Data Analyst", "Statistician", "Research Analyst",
    "Mechanical Engineer", "Civil Engineer", "Electrical Engineer",
    "Robotics Engineer", "Automation Engineer",
    "Entrepreneur", "Startup Founder", "Tech Consultant"]

# ================= HELPER FUNCTIONS =================
def login_required(f):
    """Decorator to check if user is logged in"""
    def wrapper(*args, **kwargs):
        if 'user_id' not in session:
            return redirect('/login')
        return f(*args, **kwargs)
    wrapper.__name__ = f.__name__
    return wrapper

def generate_sample_recommendations():
    """Generate sample career recommendations"""
    return [
        {
            'career_field': 'Software Engineering',
            'match_score': 85,
            'reasons': 'Strong analytical skills and technical aptitude'
        },
        {
            'career_field': 'Data Science',
            'match_score': 75,
            'reasons': 'Good with numbers and problem-solving'
        },
        {
            'career_field': 'Project Management',
            'match_score': 65,
            'reasons': 'Leadership skills and organizational abilities'
        }
    ]

def calculate_skill_distribution():
    """Calculate sample skill distribution"""
    return {
        'technical': random.randint(60, 90),
        'analytical': random.randint(50, 85),
        'communication': random.randint(40, 80),
        'leadership': random.randint(30, 75)
    }

# ================= OTP SENDER =================
def otpSender(receiver_email, otp):
    """Send OTP to email"""
    import smtplib
    
    sender_email = 'gajerayash999@gmail.com'
    password = 'rpud ypzz mnyb foaa'
    
    mail = f"Your CareerLens OTP is {otp}"
    
    try:
        with smtplib.SMTP('smtp.gmail.com', 587) as send:
            send.starttls()
            send.login(sender_email, password)
            send.sendmail(sender_email, receiver_email, mail)
        print(f"OTP {otp} sent to {receiver_email}")
        return True
    except Exception as e:
        print(f"Failed to send OTP: {e}")
        return False

# ================= ROUTES =================
@app.route('/')
def home():
    """Home page"""
    return render_template('home.html')

@app.route('/home-login')
@login_required
def homeLogin():
    user_id = session['user_id']
    user = db.session.get(User, user_id)

    if not user:
        session.clear()
        return redirect('/login')

    # Recent assessments
    assessments = Assessment.query.filter_by(user_id=user_id).order_by(
        Assessment.completed_at.desc()
    ).limit(5).all()

    # Total assessments
    total_assessments = Assessment.query.filter_by(user_id=user_id).count()

    # Average score
    avg_score = 0
    if total_assessments > 0:
        total_score = db.session.query(db.func.sum(Assessment.score)) \
                                .filter_by(user_id=user_id).scalar()
        if total_score:
            avg_score = round(total_score / total_assessments)

    # ===============================
    # SELECTED CAREER FIELDS (USER)
    # ===============================
    selected_fields = UserCareerField.query.filter_by(user_id=user_id).all()

    # Convert selected fields to list
    career_fields = []
    for f in selected_fields:
        career_fields.append({
            "career_field": f.career_field,
            # Removed match_score
        })

    # Unlock assessment if at least 1 field selected
    is_unlocked = True if len(selected_fields) >= 1 else False

    return render_template(
        'dashboard.html',
        user=user,
        total_assessments=total_assessments,
        avg_score=avg_score,
        career_fields=career_fields,
        assessments=assessments,
        is_unlocked=is_unlocked,
        ALL_CAREERS=ALL_CAREERS
    )

@app.route('/career-fields')
@login_required
def career_fields_page():
    return render_template(
        "career_fields.html",
        all_careers=ALL_CAREERS
    )


@app.route('/select-career-fields', methods=['POST'])
@login_required
def select_career_fields():
    user_id = session['user_id']
    selected = request.form.getlist('career_fields')

    if len(selected) < 1:
        return "Select at least one field", 400

    if len(selected) > 5:
        return "Select only 5 fields", 400

    # delete old
    UserCareerField.query.filter_by(user_id=user_id).delete()

    # insert new
    for field in selected:
        db.session.add(UserCareerField(user_id=user_id, career_field=field))

    db.session.commit()
    return redirect('/home-login')


@app.route('/profile')
@login_required
def profile():
    """User profile page"""
    user_id = session['user_id']
    user = User.query.get(user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    # Get assessment stats
    total_assessments = Assessment.query.filter_by(user_id=user_id).count()
    avg_score = 0
    if total_assessments > 0:
        total_score = db.session.query(db.func.sum(Assessment.score)).filter_by(user_id=user_id).scalar()
        if total_score:
            avg_score = round(total_score / total_assessments)
    
    return render_template('profile.html', 
                          user=user,
                          total_assessments=total_assessments,
                          avg_score=avg_score)

@app.route('/update-profile', methods=['POST'])
@login_required
def update_profile():
    """Update user profile"""
    user_id = session['user_id']
    user = User.query.get(user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    user.bio = request.form.get('bio', '')
    user.skills = request.form.get('skills', '')
    user.interests = request.form.get('interests', '')
    
    db.session.commit()
    
    return redirect('/profile')

@app.route('/assessment/<assessment_type>')
@login_required
def assessment(assessment_type):
    """Assessment page - handles both career and aptitude tests"""
    user_id = session['user_id']
    user = db.session.get(User, user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    if assessment_type == 'career':
        # Check if user has selected career fields
        selected_fields = UserCareerField.query.filter_by(user_id=user_id).all()
        
        if not selected_fields:
            flash("Please select career fields first!", "warning")
            return redirect('/home-login')
        
        # Store in session for career test
        session['selected_career_fields'] = [field.career_field for field in selected_fields]
        
        # Redirect directly to career test start
        return redirect('/assessment/career/start')
    
    elif assessment_type == 'aptitude':
        # Render aptitude test page
        assessment_names = {
            'aptitude': 'Aptitude Test',
            'career': 'Career Test'
        }
        assessment_name = assessment_names.get(assessment_type, 'Assessment')
        
        return render_template('assessment.html',
                              user=user,
                              assessment_type=assessment_type,
                              assessment_name=assessment_name)
    else:
        return redirect('/home-login')
    
@app.route('/assessment/career/start')
@login_required
def career_test_start_direct():
    """Direct start for career test"""
    return redirect('/assessment/career')

@app.route('/assessment/career')
@login_required
def career_test_start():
    """Start career test - shows first question"""
    user_id = session['user_id']
    user = db.session.get(User, user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    # Check if user has selected career fields
    if 'selected_career_fields' not in session:
        selected_fields = UserCareerField.query.filter_by(user_id=user_id).all()
        
        if not selected_fields:
            flash("Please select career fields first!", "warning")
            return redirect('/home-login')
        
        # Store in session for career test
        session['selected_career_fields'] = [field.career_field for field in selected_fields]
    
    selected_fields = session.get('selected_career_fields', [])
    print(f"Selected career fields: {selected_fields}")
    
    # Get questions based on selected fields
    all_questions = Question.query.filter(
        Question.career_field.in_(selected_fields)
    ).all()
    
    print(f"Found {len(all_questions)} questions for selected fields")
    
    if not all_questions:
        # Fallback to ANY questions if no specific ones found
        all_questions = Question.query.order_by(db.func.random()).limit(30).all()
        print(f"Using {len(all_questions)} random questions as fallback")
    
    # If still no questions, show error
    if not all_questions:
        flash("No questions available in the database. Please contact administrator.", "danger")
        return redirect('/home-login')
    
    # Ensure we have at least 20 questions
    if len(all_questions) < 20:
        # Add random questions to reach 20
        question_ids = [q.id for q in all_questions]
        additional = Question.query.filter(
            ~Question.id.in_(question_ids)
        ).order_by(db.func.random()).limit(20 - len(all_questions)).all()
        all_questions.extend(additional)
        print(f"Added {len(additional)} additional questions")
    
    # Shuffle questions and take first 20
    random.shuffle(all_questions)
    all_questions = all_questions[:20]
    
    print(f"Final question count: {len(all_questions)}")
    
    # Store in session
    session['career_test_questions'] = [q.id for q in all_questions]
    session['current_question_index'] = 0
    session['user_answers'] = {}
    session['test_started'] = True
    
    # Check if we have questions
    if not session['career_test_questions']:
        flash("No questions available for the test. Please try again.", "danger")
        return redirect('/home-login')
    
    # Get first question
    first_question_id = session['career_test_questions'][0]
    first_question = Question.query.get(first_question_id)
    
    return render_template('career_quiz.html',
                          user=user,
                          question=first_question,
                          question_number=1,
                          total_questions=20,
                          assessment_name='Career Test')

@app.route('/submit-assessment', methods=['POST'])
@login_required
def submit_assessment():
    user_id = session['user_id']
    assessment_type = request.form['assessment_type']
    score = int(request.form['score'])

    new_assessment = Assessment(
        user_id=user_id,
        assessment_type=assessment_type,
        score=score
    )
    db.session.add(new_assessment)
    db.session.commit()

    # After all 4 assessments completed → generate career fields
    total = Assessment.query.filter_by(user_id=user_id).count()
    if total >= 4:
        generate_career_fields(user_id)

    return redirect('/home-login')

def generate_career_fields(user_id):
    # Delete old recommendations
    CareerRecommendation.query.filter_by(user_id=user_id).delete()

    # Pick 20–30 random career fields
    selected = random.sample(ALL_CAREERS, 25)

    for career in selected:
        rec = CareerRecommendation(
            user_id=user_id,
            career_field=career,
            match_score=random.randint(50, 95)
        )
        db.session.add(rec)

    db.session.commit()


@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500

@app.route('/assessment/career/question/<int:question_num>')
@login_required
def career_question(question_num):
    """Get specific question in the test"""
    user_id = session['user_id']
    user = User.query.get(user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    # Check if test is started
    if 'career_test_questions' not in session:
        flash("Please start the test first!")
        return redirect('/assessment/career')
    
    question_index = question_num - 1
    
    # Check if question number is valid
    if question_index < 0 or question_index >= len(session['career_test_questions']):
        flash("Invalid question number!")
        return redirect('/assessment/career')
    
    # Get the question
    question_id = session['career_test_questions'][question_index]
    question = Question.query.get(question_id)
    
    # Get user's previous answer if any
    user_answer = session.get('user_answers', {}).get(str(question_id))
    
    return render_template('career_quiz.html',
                          user=user,
                          question=question,
                          question_number=question_num,
                          total_questions=len(session['career_test_questions']),
                          user_answer=user_answer,
                          assessment_name='Career Test')

@app.route('/assessment/career/save-answer', methods=['POST'])
@login_required
def save_answer():
    """Save user's answer and go to next question"""
    user_id = session['user_id']
    
    # Get current question number
    current_q = int(request.form.get('current_question', 1))
    question_id = int(request.form.get('question_id'))
    user_answer = request.form.get('answer')
    
    # Check if answer was selected
    if not user_answer:
        flash("Please select an answer!")
        return redirect(f'/assessment/career/question/{current_q}')
    
    # Save the answer
    if 'user_answers' not in session:
        session['user_answers'] = {}
    session['user_answers'][str(question_id)] = user_answer
    
    # Check if this is the last question
    total_questions = len(session['career_test_questions'])
    if current_q >= total_questions:
        # All questions answered, show review or submit
        return redirect('/assessment/career/review')
    
    # Go to next question
    next_question = current_q + 1
    return redirect(f'/assessment/career/question/{next_question}')

@app.route('/assessment/career/review')
@login_required
def review_test():
    """Review all answers before submission"""
    user_id = session['user_id']
    user = User.query.get(user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    if 'career_test_questions' not in session:
        flash("Please complete the test first!")
        return redirect('/assessment/career')
    
    # Collect all questions with user answers
    questions_data = []
    total_score = 0
    
    for i, q_id in enumerate(session['career_test_questions']):
        question = Question.query.get(q_id)
        user_answer = session.get('user_answers', {}).get(str(q_id))
        
        is_correct = False
        if user_answer:
            is_correct = (user_answer == question.correct_option)
            if is_correct:
                total_score += 5  # 5 points per correct answer
        
        questions_data.append({
            'number': i + 1,
            'question': question,
            'user_answer': user_answer,
            'correct_answer': question.correct_option,
            'is_correct': is_correct
        })
    
    # Calculate percentage
    percentage = (total_score / 100) * 100
    
    return render_template('test_review.html',
                          user=user,
                          questions=questions_data,
                          total_score=total_score,
                          percentage=percentage)

@app.route('/assessment/career/submit', methods=['POST'])
@login_required
def submit_career_test():
    """Submit the completed test"""
    user_id = session['user_id']
    
    # Calculate final score
    total_score = 0
    total_questions = len(session['career_test_questions'])
    
    for q_id in session['career_test_questions']:
        question = Question.query.get(q_id)
        user_answer = session.get('user_answers', {}).get(str(q_id))
        
        if user_answer == question.correct_option:
            total_score += 5  # 5 points per correct answer
    
    # Calculate percentage
    percentage = (total_score / (total_questions * 5)) * 100
    
    # Save assessment result
    new_assessment = Assessment(
        user_id=user_id,
        assessment_type='career',
        score=int(percentage)
    )
    db.session.add(new_assessment)
    db.session.commit()
    
    # Mark test as submitted
    session['test_submitted'] = True
    
    flash(f'Test submitted! Your score: {int(percentage)}%')
    return redirect('/home-login')

@app.route('/reports')
@login_required
def reports():
    """Reports page"""
    user_id = session['user_id']
    user = User.query.get(user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    # Get user assessments
    assessments = Assessment.query.filter_by(user_id=user_id).order_by(Assessment.completed_at.desc()).all()
    
    # Calculate stats
    total_assessments = len(assessments)
    
    # Generate sample data
    skill_distribution = calculate_skill_distribution()
    recommendations = generate_sample_recommendations()
    
    return render_template('reports.html',
                          user=user,
                          assessments=assessments,
                          total_assessments=total_assessments,
                          skill_distribution=skill_distribution,
                          recommendations=recommendations)

@app.route('/resources')
@login_required
def resources():
    """Resources page"""
    user_id = session['user_id']
    user = User.query.get(user_id)
    
    if not user:
        session.clear()
        return redirect('/login')
    
    # Sample career fields based on user interests
    career_fields = []
    if user.interests:
        interests_list = [i.strip() for i in user.interests.split(',')]
        career_fields = interests_list[:3]
    
    return render_template('resources.html',
                          user=user,
                          career_fields=career_fields)

# ================= LOGIN =================
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        # ===== SEND OTP =====
        if 'l_otp' not in request.form:
            email = request.form.get('l_email')
            password = request.form.get('l_password')

            user = User.query.filter_by(email=email).first()

            # ❌ Email not found
            if not user:
                return render_template('login.html', email_not_found=True)

            # ❌ Password wrong
            if user.userPassword != password:
                return render_template('login.html', password_wrong=True)

            # ✅ SEND OTP
            otp = random.randint(100000, 999999)
            session['login_otp'] = str(otp)
            session['login_email'] = email
            session['login_user_id'] = user.id

            otpSender(email, otp)

            return render_template('login.html', show_otp_modal=True)

        # ===== VERIFY OTP =====
        else:
            inputOtp = request.form.get('l_otp')

            if inputOtp == session.get('login_otp'):
                # Set user session
                session['user_id'] = session.get('login_user_id')
                session['user_email'] = session.get('login_email')
                
                # Get user name
                user = db.session.get(User, session['user_id'])
                if user:
                    session['user_name'] = user.name
                
                # Clear OTP session
                session.pop('login_otp', None)
                session.pop('login_email', None)
                session.pop('login_user_id', None)
                
                return redirect(url_for('homeLogin'))
            else:
                return render_template('login.html', show_otp_modal=True, otp_fail=True)

    return render_template('login.html')

# ================= REGISTRATION =================
@app.route('/registation', methods=['GET', 'POST'])
def registation():
    if request.method == 'POST':
        # ===== SEND OTP =====
        if 'r_otp' not in request.form:
            name = request.form.get('r_name')
            email = request.form.get('r_email')
            password = request.form.get('r_password')
            confirm_password = request.form.get('r_confirmPassword')

            # Check if passwords match
            if password != confirm_password:
                return render_template('registation.html',
                                       registation_fail=True,
                                       r_name=name,
                                       r_email=email)

            # Check if user already exists
            existing_user = User.query.filter_by(email=email).first()
            if existing_user:
                return render_template('registation.html', registation_fail=True)

            # ✅ SEND OTP
            otp = random.randint(100000, 999999)
            session['otp'] = str(otp)
            session['reg_name'] = name
            session['reg_email'] = email
            session['reg_password'] = password

            otpSender(email, otp)

            return render_template('registation.html', show_otp_modal=True)

        # ===== VERIFY OTP =====
        else:
            inputOtp = request.form.get('r_otp')

            if inputOtp == session.get('otp'):
                # SAVE USER TO DATABASE
                new_user = User(
                    name=session['reg_name'],
                    email=session['reg_email'],
                    userPassword=session['reg_password'],
                    created_at=datetime.utcnow()
                )
                db.session.add(new_user)
                db.session.commit()

                # Get the newly created user
                user = User.query.filter_by(email=session['reg_email']).first()
                
                # Clear registration session
                session.pop('otp', None)
                session.pop('reg_name', None)
                session.pop('reg_email', None)
                session.pop('reg_password', None)

                # Auto login after registration
                if user:
                    session['user_id'] = user.id
                    session['user_email'] = user.email
                    session['user_name'] = user.name
                
                return redirect(url_for('homeLogin'))
            else:
                return render_template('registation.html',
                                       show_otp_modal=True,
                                       otp_fail=True)

    return render_template('registation.html')

@app.route('/logout')
def logout():
    """Logout user"""
    session.clear()
    return redirect('/')



def add_sample_questions():
    """Add sample questions to database if empty"""
    with app.app_context():
        count = Question.query.count()
        print(f"Current question count: {count}")
        
        if count == 0:
            print("Adding sample questions to database...")
            
            sample_questions = [
                # Software Engineering Questions
                Question(
                    career_field="Software Engineer",
                    skill="Programming",
                    question_text="Which programming language is known for its use in web development and has frameworks like Django and Flask?",
                    option_a="Python",
                    option_b="C++",
                    option_c="Java",
                    option_d="Swift",
                    correct_option="A"
                ),
                Question(
                    career_field="Software Engineer",
                    skill="Algorithms",
                    question_text="What is the time complexity of binary search?",
                    option_a="O(n)",
                    option_b="O(log n)",
                    option_c="O(n²)",
                    option_d="O(1)",
                    correct_option="B"
                ),
                Question(
                    career_field="Software Engineer",
                    skill="Databases",
                    question_text="Which SQL clause is used to filter results?",
                    option_a="SELECT",
                    option_b="FROM",
                    option_c="WHERE",
                    option_d="JOIN",
                    correct_option="C"
                ),
                
                # Data Science Questions
                Question(
                    career_field="Data Scientist",
                    skill="Statistics",
                    question_text="Which statistical test is used to compare means of two groups?",
                    option_a="Chi-square test",
                    option_b="T-test",
                    option_c="ANOVA",
                    option_d="Regression",
                    correct_option="B"
                ),
                Question(
                    career_field="Data Scientist",
                    skill="Machine Learning",
                    question_text="Which algorithm is used for classification problems?",
                    option_a="Linear Regression",
                    option_b="K-Means",
                    option_c="Decision Tree",
                    option_d="PCA",
                    correct_option="C"
                ),
                
                # Web Development Questions
                Question(
                    career_field="Web Developer",
                    skill="Frontend",
                    question_text="Which CSS property controls the space between elements?",
                    option_a="padding",
                    option_b="margin",
                    option_c="border",
                    option_d="display",
                    correct_option="B"
                ),
                Question(
                    career_field="Web Developer",
                    skill="JavaScript",
                    question_text="Which method adds an element to the end of an array?",
                    option_a="push()",
                    option_b="pop()",
                    option_c="shift()",
                    option_d="unshift()",
                    correct_option="A"
                ),
                
                # AI Engineer Questions
                Question(
                    career_field="AI Engineer",
                    skill="Neural Networks",
                    question_text="What is the purpose of the activation function in a neural network?",
                    option_a="To initialize weights",
                    option_b="To introduce non-linearity",
                    option_c="To calculate loss",
                    option_d="To optimize learning rate",
                    correct_option="B"
                ),
                
                # Project Management Questions
                Question(
                    career_field="Project Manager",
                    skill="Methodology",
                    question_text="Which methodology follows an iterative approach?",
                    option_a="Waterfall",
                    option_b="Agile",
                    option_c="V-Model",
                    option_d="Prince2",
                    correct_option="B"
                ),
                
                # Add more questions for various career fields
                Question(
                    career_field="Software Engineer",
                    skill="Data Structures",
                    question_text="Which data structure follows LIFO (Last In First Out) principle?",
                    option_a="Queue",
                    option_b="Stack",
                    option_c="Linked List",
                    option_d="Tree",
                    correct_option="B"
                ),
                Question(
                    career_field="Data Scientist",
                    skill="Programming",
                    question_text="Which library is commonly used for data manipulation in Python?",
                    option_a="NumPy",
                    option_b="Pandas",
                    option_c="Matplotlib",
                    option_d="Scikit-learn",
                    correct_option="B"
                ),
                Question(
                    career_field="AI Engineer",
                    skill="ML Basics",
                    question_text="What does the term 'overfitting' mean in machine learning?",
                    option_a="Model performs well on training data but poorly on test data",
                    option_b="Model performs poorly on both training and test data",
                    option_c="Model performs well on both training and test data",
                    option_d="Model is too simple",
                    correct_option="A"
                ),
                Question(
                    career_field="Cyber Security Expert",
                    skill="Security",
                    question_text="What is the purpose of a firewall?",
                    option_a="To prevent unauthorized access",
                    option_b="To speed up internet connection",
                    option_c="To store backup data",
                    option_d="To encrypt data",
                    correct_option="A"
                ),
                Question(
                    career_field="Business Analyst",
                    skill="Analysis",
                    question_text="What does SWOT stand for in business analysis?",
                    option_a="Strengths, Weaknesses, Opportunities, Threats",
                    option_b="Sales, Work, Operations, Training",
                    option_c="System, Web, Online, Technology",
                    option_d="Strategy, Workforce, Organization, Technology",
                    correct_option="A"
                ),
                Question(
                    career_field="Digital Marketer",
                    skill="Marketing",
                    question_text="Which metric measures the percentage of visitors who take a desired action?",
                    option_a="Click-through Rate",
                    option_b="Conversion Rate",
                    option_c="Bounce Rate",
                    option_d="Engagement Rate",
                    correct_option="B"
                ),
                Question(
                    career_field="UI/UX Designer",
                    skill="Design",
                    question_text="What does UX stand for in design?",
                    option_a="User Experience",
                    option_b="User Interface",
                    option_c="User Extension",
                    option_d="User Execution",
                    correct_option="A"
                ),
                Question(
                    career_field="Cloud Engineer",
                    skill="Cloud Computing",
                    question_text="Which service model provides virtual machines to users?",
                    option_a="IaaS",
                    option_b="PaaS",
                    option_c="SaaS",
                    option_d="FaaS",
                    correct_option="A"
                ),
                Question(
                    career_field="DevOps Engineer",
                    skill="CI/CD",
                    question_text="What does CI stand for in DevOps?",
                    option_a="Continuous Integration",
                    option_b="Continuous Improvement",
                    option_c="Continuous Implementation",
                    option_d="Continuous Innovation",
                    correct_option="A"
                ),
                Question(
                    career_field="Mobile App Developer",
                    skill="Development",
                    question_text="Which language is primarily used for Android app development?",
                    option_a="Swift",
                    option_b="Kotlin",
                    option_c="C#",
                    option_d="JavaScript",
                    correct_option="B"
                ),
                Question(
                    career_field="Graphic Designer",
                    skill="Design Tools",
                    question_text="Which software is industry standard for vector graphics?",
                    option_a="Photoshop",
                    option_b="Illustrator",
                    option_c="Figma",
                    option_d="Canva",
                    correct_option="B"
                )
            ]
            
            try:
                for question in sample_questions:
                    db.session.add(question)
                
                db.session.commit()
                print(f"✓ {len(sample_questions)} sample questions added to database!")
            except Exception as e:
                print(f"✗ Error adding sample questions: {e}")
                db.session.rollback()
        else:
            print(f"✓ Database already has {count} questions")


@app.route('/debug/questions')
def debug_questions():
    """Debug route to check questions in database"""
    total_questions = Question.query.count()
    all_questions = Question.query.all()
    
    result = f"Total questions in database: {total_questions}\n\n"
    
    for q in all_questions[:10]:  # Show first 10 questions
        result += f"ID: {q.id}, Career Field: {q.career_field}, Skill: {q.skill}\n"
        result += f"Question: {q.question_text[:50]}...\n\n"
    
    return f"<pre>{result}</pre>"

@app.route('/force-add-questions')
def force_add_questions():
    """Force add questions for testing"""
    try:
        # Add a test question
        test_question = Question(
            career_field="Software Engineer",
            skill="Test",
            question_text="Test question for debugging?",
            option_a="Option A",
            option_b="Option B",
            option_c="Option C",
            option_d="Option D",
            correct_option="A"
        )
        db.session.add(test_question)
        db.session.commit()
        
        count = Question.query.count()
        return f"Added test question! Total questions: {count}"
    except Exception as e:
        return f"Error: {e}"

@app.route('/populate-questions')
def populate_questions():
    """Temporary route to populate questions"""
    add_sample_questions()
    return redirect('/debug/questions')


def create_tables():
    """Create database tables and add sample data"""
    with app.app_context():
        db.create_all()
        print("✓ Database tables created successfully!")
        
        # Add sample questions
        add_sample_questions()            

# ================= INITIALIZE DATABASE =================
def create_tables():
    """Create database tables"""
    with app.app_context():
        db.create_all()
        print("✓ Database tables created successfully!")

# ================= RUN APP =================
if __name__ == "__main__":
    # Create database tables
    create_tables()
    
    # Run the application
    print("\n" + "="*50)
    print("CareerLens Application Starting...")
    print("="*50)
    print("Access the application at: http://localhost:5000")
    print("="*50 + "\n")
    
    app.run(debug=True, port=5000)